<!DOCTYPE html>
<html>
<head>

<style>

	html {
		background-image: url("assets/back.jpg");
	}
	
	body {
		margin: 0px;
	}

	#div1 {
		position: absolute;
		display: block;
	}

	#avail {
		color: white;
		font-size: larger;
	}
	
	#gameOver {
		font-family: 'VT323', ;
		font-size:10em;
		text-align:center;
		position: absolute;
		display: none;
		background-color: yellow;
		color: brown;
		z-index: +2000;
		height : "max-content";
		width : "max-content";

	}

	@keyframes blinking {
        0% { filter: brightness(1) }
		10% { filter: brightness(.9) }
		20% { filter: brightness(.8) }
		30% { filter: brightness(.7) }
		40% { filter: brightness(.6) }
		50% { filter: brightness(.5) }
		60% { filter: brightness(.6) }
		70% { filter: brightness(.7) }
		80% { filter: brightness(.8) }
		90% { filter: brightness(.9) }
        100% { filter: brightness(1) }
    }
	
</style>

</head>
<body onload="mahjong()">

<script type="text/javascript">

	class Slot
	{
		constructor(x, y, layer)
		{
			this.x = x;
			this.y = y;
			this.layer = layer
		}
		equals(slot)
        {
			return slot.x == this.x && slot.y == this.y && slot.layer == this.layer;
		}
	}

	function compare_slots (a, b)
	{
		/* Sort lowest to highest */
		var dl = a.layer - b.layer;
		if (dl != 0)
			return dl;

		/* Sort diagonally, top left to bottom right */
		var dx = a.x - b.x;
		var dy = a.y - b.y;
		if (dx > dy)
			return -1;
		if (dx < dy)
			return 1;

		return 0;
	}

	class Map
	{
		constructor()
		{
			this.slots = [];
		}


		static test()
		{
			var res = new Map()
			res.slots.push (new Slot (0, 0, 0));
			res.slots.push (new Slot (2, 0, 0));
			res.slots.push (new Slot (2, 0, 1));
			res.slots.push (new Slot (4, 0, 0));
			res.slots.push (new Slot (0, 2, 0));
			res.slots.push (new Slot (2, 2, 0));
			res.slots.push (new Slot (2, 2, 1));
			res.slots.push (new Slot (4, 2, 0));
			return res;
		}

		static easy()
		{
			var res = new Map()
			res.slots.push (new Slot (13, 7, 4));
			res.slots.push (new Slot (12, 8, 3));
			res.slots.push (new Slot (14, 8, 3));
			res.slots.push (new Slot (12, 6, 3));
			res.slots.push (new Slot (14, 6, 3));
			res.slots.push (new Slot (10, 10, 2));
			res.slots.push (new Slot (12, 10, 2));
			res.slots.push (new Slot (14, 10, 2));
			res.slots.push (new Slot (16, 10, 2));
			res.slots.push (new Slot (10, 8, 2));
			res.slots.push (new Slot (12, 8, 2));
			res.slots.push (new Slot (14, 8, 2));
			res.slots.push (new Slot (16, 8, 2));
			res.slots.push (new Slot (10, 6, 2));
			res.slots.push (new Slot (12, 6, 2));
			res.slots.push (new Slot (14, 6, 2));
			res.slots.push (new Slot (16, 6, 2));
			res.slots.push (new Slot (10, 4, 2));
			res.slots.push (new Slot (12, 4, 2));
			res.slots.push (new Slot (14, 4, 2));
			res.slots.push (new Slot (16, 4, 2));
			res.slots.push (new Slot (8, 12, 1));
			res.slots.push (new Slot (10, 12, 1));
			res.slots.push (new Slot (12, 12, 1));
			res.slots.push (new Slot (14, 12, 1));
			res.slots.push (new Slot (16, 12, 1));
			res.slots.push (new Slot (18, 12, 1));
			res.slots.push (new Slot (8, 10, 1));
			res.slots.push (new Slot (10, 10, 1));
			res.slots.push (new Slot (12, 10, 1));
			res.slots.push (new Slot (14, 10, 1));
			res.slots.push (new Slot (16, 10, 1));
			res.slots.push (new Slot (18, 10, 1));
			res.slots.push (new Slot (8, 8, 1));
			res.slots.push (new Slot (10, 8, 1));
			res.slots.push (new Slot (12, 8, 1));
			res.slots.push (new Slot (14, 8, 1));
			res.slots.push (new Slot (16, 8, 1));
			res.slots.push (new Slot (18, 8, 1));
			res.slots.push (new Slot (8, 6, 1));
			res.slots.push (new Slot (10, 6, 1));
			res.slots.push (new Slot (12, 6, 1));
			res.slots.push (new Slot (14, 6, 1));
			res.slots.push (new Slot (16, 6, 1));
			res.slots.push (new Slot (18, 6, 1));
			res.slots.push (new Slot (8, 4, 1));
			res.slots.push (new Slot (10, 4, 1));
			res.slots.push (new Slot (12, 4, 1));
			res.slots.push (new Slot (14, 4, 1));
			res.slots.push (new Slot (16, 4, 1));
			res.slots.push (new Slot (18, 4, 1));
			res.slots.push (new Slot (8, 2, 1));
			res.slots.push (new Slot (10, 2, 1));
			res.slots.push (new Slot (12, 2, 1));
			res.slots.push (new Slot (14, 2, 1));
			res.slots.push (new Slot (16, 2, 1));
			res.slots.push (new Slot (18, 2, 1));
			res.slots.push (new Slot (2, 14, 0));
			res.slots.push (new Slot (4, 14, 0));
			res.slots.push (new Slot (6, 14, 0));
			res.slots.push (new Slot (8, 14, 0));
			res.slots.push (new Slot (10, 14, 0));
			res.slots.push (new Slot (12, 14, 0));
			res.slots.push (new Slot (14, 14, 0));
			res.slots.push (new Slot (16, 14, 0));
			res.slots.push (new Slot (18, 14, 0));
			res.slots.push (new Slot (20, 14, 0));
			res.slots.push (new Slot (22, 14, 0));
			res.slots.push (new Slot (24, 14, 0));
			res.slots.push (new Slot (6, 12, 0));
			res.slots.push (new Slot (8, 12, 0));
			res.slots.push (new Slot (10, 12, 0));
			res.slots.push (new Slot (12, 12, 0));
			res.slots.push (new Slot (14, 12, 0));
			res.slots.push (new Slot (16, 12, 0));
			res.slots.push (new Slot (18, 12, 0));
			res.slots.push (new Slot (20, 12, 0));
			res.slots.push (new Slot (4, 10, 0));
			res.slots.push (new Slot (6, 10, 0));
			res.slots.push (new Slot (8, 10, 0));
			res.slots.push (new Slot (10, 10, 0));
			res.slots.push (new Slot (12, 10, 0));
			res.slots.push (new Slot (14, 10, 0));
			res.slots.push (new Slot (16, 10, 0));
			res.slots.push (new Slot (18, 10, 0));
			res.slots.push (new Slot (20, 10, 0));
			res.slots.push (new Slot (22, 10, 0));
			res.slots.push (new Slot (0, 7, 0));
			res.slots.push (new Slot (2, 8, 0));
			res.slots.push (new Slot (4, 8, 0));
			res.slots.push (new Slot (6, 8, 0));
			res.slots.push (new Slot (8, 8, 0));
			res.slots.push (new Slot (10, 8, 0));
			res.slots.push (new Slot (12, 8, 0));
			res.slots.push (new Slot (14, 8, 0));
			res.slots.push (new Slot (16, 8, 0));
			res.slots.push (new Slot (18, 8, 0));
			res.slots.push (new Slot (20, 8, 0));
			res.slots.push (new Slot (22, 8, 0));
			res.slots.push (new Slot (24, 8, 0));
			res.slots.push (new Slot (2, 6, 0));
			res.slots.push (new Slot (4, 6, 0));
			res.slots.push (new Slot (6, 6, 0));
			res.slots.push (new Slot (8, 6, 0));
			res.slots.push (new Slot (10, 6, 0));
			res.slots.push (new Slot (12, 6, 0));
			res.slots.push (new Slot (14, 6, 0));
			res.slots.push (new Slot (16, 6, 0));
			res.slots.push (new Slot (18, 6, 0));
			res.slots.push (new Slot (20, 6, 0));
			res.slots.push (new Slot (22, 6, 0));
			res.slots.push (new Slot (24, 6, 0));
			res.slots.push (new Slot (4, 4, 0));
			res.slots.push (new Slot (6, 4, 0));
			res.slots.push (new Slot (8, 4, 0));
			res.slots.push (new Slot (10, 4, 0));
			res.slots.push (new Slot (12, 4, 0));
			res.slots.push (new Slot (14, 4, 0));
			res.slots.push (new Slot (16, 4, 0));
			res.slots.push (new Slot (18, 4, 0));
			res.slots.push (new Slot (20, 4, 0));
			res.slots.push (new Slot (22, 4, 0));
			res.slots.push (new Slot (6, 2, 0));
			res.slots.push (new Slot (8, 2, 0));
			res.slots.push (new Slot (10, 2, 0));
			res.slots.push (new Slot (12, 2, 0));
			res.slots.push (new Slot (14, 2, 0));
			res.slots.push (new Slot (16, 2, 0));
			res.slots.push (new Slot (18, 2, 0));
			res.slots.push (new Slot (20, 2, 0));
			res.slots.push (new Slot (2, 0, 0));
			res.slots.push (new Slot (4, 0, 0));
			res.slots.push (new Slot (6, 0, 0));
			res.slots.push (new Slot (8, 0, 0));
			res.slots.push (new Slot (10, 0, 0));
			res.slots.push (new Slot (12, 0, 0));
			res.slots.push (new Slot (14, 0, 0));
			res.slots.push (new Slot (16, 0, 0));
			res.slots.push (new Slot (18, 0, 0));
			res.slots.push (new Slot (20, 0, 0));
			res.slots.push (new Slot (22, 0, 0));
			res.slots.push (new Slot (24, 0, 0));
			res.slots.push (new Slot (26, 7, 0));
			res.slots.push (new Slot (28, 7, 0));
			return res;
	        }

                width()
                {
                    var w = 0;
			        this.slots.forEach(
			        slot =>
			        {
			            if (slot.x > w)
                            w = slot.x;
			        });
                    return w + 2;
                }

	        height()
                {
                    var h = 0;
			        this.slots.forEach(
			        slot =>
			        {
			            if (slot.y > h)
                            h = slot.y;
			        });
                    return h + 2;
                }
	}

	class Tile
	{
		constructor(slot)
		{
			this.number = 0;
			this.slot = slot;
			this.visible = true
			this.move_number = 0;
		}

		set()
                {
			return Math.trunc(this.number / 4);
		}

		matches(tile)
                {
			return tile.set() == this.set();
		}

		equals(tile)
                {
			return tile.slot.equals(this.slot);
		}
	}

	
	function compare_tiles(a, b)
	{
		return compare_slots (a.slot, b.slot);
	}


	function switch_tiles(a, b)
	{
		if (a.visible && b.visible)
		{
			var h = a.slot;
			a.slot = b.slot;
			b.slot = h;
			return true;
		}
		return false;
	}

	class Match
	{
		constructor(tile0, tile1)
		{
		        this.tile0 = tile0;
			this.tile1 = tile1;
		}
	}


	let tw = 100;
	let th = 120;
	let tileSpacing = 13;
	
	let selectedTile = -1;
	
	const tiles_obso = [
		"b1","b2","b3","b4","b5","b6","b7","b8","b9",
		"b1","b2","b3","b4","b5","b6","b7","b8","b9",
		"b1","b2","b3","b4","b5","b6","b7","b8","b9",
		"b1","b2","b3","b4","b5","b6","b7","b8","b9",
		"c1","c2","c3","c4","c5","c6","c7","c8","c9",
		"c1","c2","c3","c4","c5","c6","c7","c8","c9",
		"c1","c2","c3","c4","c5","c6","c7","c8","c9",
		"c1","c2","c3","c4","c5","c6","c7","c8","c9",
		"d1","d2","d3","d4","d5","d6","d7","d8","d9",
		"d1","d2","d3","d4","d5","d6","d7","d8","d9",
		"d1","d2","d3","d4","d5","d6","d7","d8","d9",
		"d1","d2","d3","d4","d5","d6","d7","d8","d9",
		"dr","dg","dw",
		"dr","dg","dw",
		"dr","dg","dw",
		"dr","dg","dw",
		"we","ws","ww","wn", 
		"we","ws","ww","wn", 
		"we","ws","ww","wn", 
		"we","ws","ww","wn",
		"s_sp", "s_su", "s_a", "s_w",
		"f_p", "f_o", "f_c", "f_b"
	];
	
    let showAv = 0;
	let undo = [];

	
	// *************  Game 
	var map = Map.easy()
	// var map = Map.test()

	console.log(map.width())
	console.log(map.height())

	var tiles = []
	move_number = 1;	

	map.slots.forEach(
		slot => 
		{
			var tile = new Tile(slot);
			tile.number = 0;
			tiles.push(tile)
		});
	tiles.sort(compare_tiles)
	
	// var tx = tiles[5];
	// tx.number = 5;

	var n_pairs = tiles.length / 2;
	var numbers = new Array(n_pairs);
	for (var i = 0; i < n_pairs; i++)
		numbers[i] = i * 2;
	for (var i = 0; i < n_pairs; i++)
	{
		//var n = Random.int_range (i, n_pairs);
		var n = i + Math.trunc(Math.random() * (n_pairs - i));
		var t = numbers[i];
		numbers[i] = numbers[n];
		numbers[n] = t;
	}

	// find_matches_calls = 0;

	shuffle(numbers);
	// console.log("find_matches_calls: " + find_matches_calls)
	console.log("shuffle done")

	

	function shuffle(numbers, depth = 0)
	{
		// console.log("depth:", depth)
		if (depth == tiles.length  / 2)
			return true;
	
		// console.log("----------------------------")
		var matches = find_matches();
        var n_matches = matches.length;
        
		/* No matches on this branch, rewind */
        if (n_matches == 0)
            return false;

		//var n = Random.int_range (0, (int) n_matches);
		var n = Math.trunc(Math.random() * n_matches);
		for (var i = 0; i < n_matches; i++)
		{
            //var match = matches.nth_data ((n + i) % n_matches);
			var match = matches[(n + i) % n_matches];
            match.tile0.number = numbers[depth];
            match.tile0.visible = false;
            match.tile1.number = numbers[depth] + 1;
            match.tile1.visible = false;

            if (shuffle (numbers, depth + 1))
                return true;

            /* Undo this move */
            match.tile0.number = 0;
            match.tile0.visible = true;
            match.tile1.number = 0;
            match.tile1.visible = true;
        }
		
		return false;
	}



	function find_matches(tile = null)
	{
		// find_matches_calls++;
		var matches = []
		if (tile != null && !tile_can_move(tile))
		{
			// console.log("return #1 matches num: "+ matches.length);
            return matches;
		}

		if (tile == null)
        {
            //foreach (var t in tiles)
			tiles.forEach(t =>
            {
                // foreach (var match in find_matches (t))
				if (t == null)
					console.log("CODE ERROR")
				var fm = find_matches(t)
				fm.forEach(match => 
                {
                    already_matched = false;
                    // foreach (var existing_match in matches)
					matches.every(existing_match =>
                    {
                        // if (existing_match.tile0 == match.tile1 && existing_match.tile1 == match.tile0)
						if (existing_match.tile0.equals(match.tile0) && existing_match.tile1.equals(match.tile1) 
					     || existing_match.tile0.equals(match.tile1) && existing_match.tile1.equals(match.tile0)
					       )
                        {
                            already_matched = true;
                            return false;
                        }
						return true;
                    })

                    if (!already_matched)
                        matches.push(match);
                })
            })
        }
        else
        {
            //foreach (var t in tiles)
			tiles.every(t =>
            {
                if (t == tile || !tile_can_move(t))
                    return true

                if (t.matches(tile))
                    matches.push(new Match(t, tile));
				return true
            })
        }
		// if (tile == null)
		//  	console.log("out: return #2 matches num: "+ matches.length);
        return matches;
	}


	function tile_can_move(tile)
    {
        if (!tile.visible)
            return false;

        var blocked_left = false;
        var blocked_right = false;
        var slot = tile.slot;
		//var result = true;
        //foreach (var t in tiles)
		//tiles.every(t =>
		for (var i = 0; i < tiles.length; i++)
        {
			t = tiles[i];

			if (t == tile || !t.visible)
				continue;
                //return true;

			var s = t.slot;

			/* Can't move if blocked by a tile above */
			if (s.layer == slot.layer + 1 &&
				(s.x >= slot.x - 1 && s.x <= slot.x + 1) &&
				(s.y >= slot.y - 1 && s.y <= slot.y + 1))
				{
					//result = false;
					return false;
				}

			/* Can't move if blocked both on the left and the right */
			if (s.layer == slot.layer && (s.y >= slot.y - 1 && s.y <= slot.y + 1))
			{
				if (s.x == slot.x - 2)
					blocked_left = true;
				if (s.x == slot.x + 2)
					blocked_right = true;
				if (blocked_left && blocked_right)
				{
					//result = false;
					return false;
				}
			}
			//return true;
        }//)

        //return result;
		return true;
    }
	
	// *********** TODO				


	let tileMap = [
	
		[7,1,0,-1,[],""], [7,2,0,-1,[0,2],""], [7,3,0,-1,[1,3],""], [7,4,0,-1,[2,4],""], [7,5,0,-1,[3,5],""], [7,6,0,-1,[4,6],""], [7,7,0,-1,[5,7],""], [7,8,0,-1,[6,8],""], [7,9,0,-1,[7,9],""], [7,10,0,-1,[8,10],""], [7,11,0,-1,[9,11],""], [7,12,0,-1,[],""], 
		[6,3,0,-1,[],""], [6,4,0,87,[12,14],""], [6,5,0,88,[13,15],""], [6,6,0,89,[14,16],""], [6,7,0,90,[15,17],""], [6,8,0,91,[16,18],""], [6,9,0,92,[17,19],""], [6,10,0,-1,[],""],
		[5,2,0,-1,[],""], [5,3,0,-1,[20,22],""], [5,4,0,93,[21,23],""], [5,5,0,94,[22,24],""], [5,6,0,95,[23,25],""], [5,7,0,96,[24,26],""], [5,8,0,97,[25,27],""], [5,9,0,98,[26,28],""], [5,10,0,-1,[27,29],""], [5,11,0,-1,[],""],
		[3.5,0,0,-1,[],""],
		[4,1,0,-1,[30,32],""], [4,2,0,-1,[31,33],""], [4,3,0,-1,[32,34],""], [4,4,0,99,[33,35],""], [4,5,0,100,[34,36],""], [4,6,0,101,[35,37],""], [4,7,0,102,[36,38],""], [4,8,0,103,[37,39],""], [4,9,0,104,[38,40],""], [4,10,0,-1,[39,41],""], [4,11,0,-1,[40,42],""], [4,12,0,-1,[41,55],""], 
		[3,1,0,-1,[30,44],""], [3,2,0,-1,[43,45],""], [3,3,0,-1,[44,46],""], [3,4,0,105,[45,47],""], [3,5,0,106,[46,48],""], [3,6,0,107,[47,49],""], [3,7,0,108,[48,50],""], [3,8,0,109,[49,51],""], [3,9,0,110,[50,52],""], [3,10,0,-1,[51,53],""], [3,11,0,-1,[52,54],""], [3,12,0,-1,[53,55],""],
		
		//[3.5,13,0,-1,[56,[54,42]],""], [3.5,14,0,-1,[],""],
		[3.5,13,0,-1, [56, 54, 42], ""], [3.5,14,0,-1,[],""],


		[2,2,0,-1,[],""], [2,3,0,-1,[57,59],""], [2,4,0,111,[58,60],""], [2,5,0,112,[59,61],""], [2,6,0,113,[60,62],""], [2,7,0,114,[61,63],""], [2,8,0,115,[62,64],""], [2,9,0,116,[63,65],""], [2,10,0,-1,[64,66],""], [2,11,0,-1,[],""],
		[1,3,0,-1,[],""], [1,4,0,117,[67,69],""], [1,5,0,118,[68,70],""], [1,6,0,119,[69,71],""], [1,7,0,120,[70,72],""], [1,8,0,121,[71,73],""], [1,9,0,122,[72,74],""], [1,10,0,-1,[],""],
		[0,1,0,-1,[],""], [0,2,0,-1,[75,77],""], [0,3,0,-1,[76,78],""], [0,4,0,-1,[77,79],""], [0,5,0,-1,[78,80],""], [0,6,0,-1,[79,81],""], [0,7,0,-1,[80,82],""], [0,8,0,-1,[81,83],""], [0,9,0,-1,[82,84],""], [0,10,0,-1,[83,85],""], [0,11,0,-1,[84,86],""], [0,12,0,-1,[],""], 
		
		[6,4,1,-1,[],""], [6,5,1,-1,[87,89],""], [6,6,1,-1,[88,90],""], [6,7,1,-1,[89,91],""], [6,8,1,-1,[90,92],""], [6,9,1,-1,[],""],
		[5,4,1,-1,[],""], [5,5,1,123,[93,95],""], [5,6,1,124,[94,96],""], [5,7,1,125,[95,97],""], [5,8,1,126,[96,98],""], [5,9,1,-1,[],""],
		[4,4,1,-1,[],""], [4,5,1,127,[99,101],""], [4,6,1,128,[100,102],""], [4,7,1,129,[101,103],""], [4,8,1,130,[102,104],""], [4,9,1,-1,[],""],
		[3,4,1,-1,[],""], [3,5,1,131,[105,107],""], [3,6,1,132,[106,108],""], [3,7,1,133,[107,109],""], [3,8,1,134,[108,110],""], [3,9,1,-1,[],""],
		[2,4,1,-1,[],""], [2,5,1,135,[111,113],""], [2,6,1,136,[112,114],""], [2,7,1,137,[113,115],""], [2,8,1,138,[114,116],""], [2,9,1,-1,[],""],
		[1,4,1,-1,[],""], [1,5,1,-1,[117,119],""], [1,6,1,-1,[118,120],""], [1,7,1,-1,[119,121],""], [1,8,1,-1,[120,122],""], [1,9,1,-1,[],""],
		
		[5,5,2,-1,[],""], [5,6,2,-1,[123,125],""], [5,7,2,-1,[124,126],""], [5,8,2,-1,[],""],
		[4,5,2,-1,[],""], [4,6,2,139,[127,129],""], [4,7,2,140,[128,130],""], [4,8,2,-1,[],""],
		[3,5,2,-1,[],""], [3,6,2,141,[131,133],""], [3,7,2,142,[132,134],""], [3,8,2,-1,[],""],
		[2,5,2,-1,[],""], [2,6,2,-1,[135,137],""], [2,7,2,-1,[136,138],""], [2,8,2,-1,[],""],
		
		[4,6,3,143,[],""], [4,7,3,143,[],""],
		[3,6,3,143,[],""], [3,7,3,143,[],""],
		
		[3.5,6.5,4,-1,[],""]
		
	];
			

	function shuffledTiles(num) {
		let tiles = [...Array(144).keys()]
		for (let k = 0; k < 3; k++)
		for (let i = tiles.length - 1; i > 0; i--) {
			const idx = Math.floor(Math.random() * (i + 1));
			const tmp = tiles[i];
			tiles[i] = tiles[idx];
			tiles[idx] = tmp;
		}
		return tiles;
	}


	function mahjong() {
	
		// ver 1.01 (2022-10-04 ) - dodano undo
	
		// TODO: parametry startowe z lini poleceń, np do wyboru zestawu kloców
		const params = new URLSearchParams(window.location.search);
		
		th = Math.round(window.innerHeight / 10) // 7.7);
		tw = Math.round(th * (100/135));
		tileSpacing = Math.round(th / 12); // /8);
		const divHeight = ((th - tileSpacing) * 8) + tileSpacing;
		const divWidth = ((tw - tileSpacing) * 15) + tileSpacing;
		var div1 = document.getElementById("div1")
		div1.style.height = divHeight + "px";
		div1.style.width = divWidth + "px";
		div1.style.top = ((window.innerHeight - divHeight) / 2) + "px";
		div1.style.left = ((window.innerWidth - divWidth) / 2) + "px";
		
		let a1 = shuffledTiles(144)
		
		if(0)
		{
			for(let i = 0; i < tileMap.length; i++) 
				tileMap[i][6] = i;
			tileMap.sort(
				function(a, b) {
					av = a[0] + 20 * (20 - a[1]) + 400 * a[2]
					bv = b[0] + 20 * (20 - b[1]) + 400 * b[2]
					return av - bv;
				})
		}

		// for(let i = 0; i < tileMap.length; i++)
		for (let i = 0; i < tiles.length; i++)
		{
			
			let img1 = new Image();
			// img1.src = "./tiles/01/" + tiles_obso[a1[i]] + ".png"; //+ ".svg";
			// tileMap[i][5] = tiles_obso[a1[i]];

			var tile = tiles[i]
			var tile_name = tiles_obso[tile.number]

			img1.src = "./tiles/01/" + tile_name + ".png"; //+ ".svg";

			img1.width = tw;
			img1.height = th;
			img1.style.position = "absolute";
			img1.id = i;
			img1.onclick = tileClick;
			
			// TODO OFF ??
			// if(i < 87) {
			// 	img1.style.zIndex = 100 - i;
			// }
			// else if(i < 123) {
			// 	img1.style.zIndex = 200 - i;
			// }
			// else if(i < 139) {
			// 	img1.style.zIndex = 250 - i;
			// }
			// else if(i < 143) {
			// 	img1.style.zIndex = 300 - i;
			// }
			// else {
			// 	img1.style.zIndex = 301;
			// }

			// let offset = tileMap[i][2] * tileSpacing;
			// img1.style.top = ((tileMap[i][0] * (th - tileSpacing)) - offset) + "px";
			// img1.style.left = ((tileMap[i][1] * (tw - tileSpacing)) + offset) + "px";

			let offset = tile.slot.layer * tileSpacing;
			img1.style.top = ((tile.slot.y/2 * (th - tileSpacing)) - offset) + "px";
			img1.style.left = ((tile.slot.x/2 * (tw - tileSpacing)) + offset) + "px";

			//img1.title = i;
			document.getElementById("div1").appendChild(img1);
		}
	
		checkAvailableMoves();
	
	}
	
	
	
	function isLocked(id) {
		
		let locked = true;
		
		let o = tileMap[id];
		let tilesToCheck = tileMap[id][4];
		
		for(let i = 0; i < tilesToCheck.length; i++) {
			tc = tilesToCheck[i];
			//tcn = tileMap.filter(o => o[6] == tc)[0]
			//if (tcn[5] == "") {
			if (tileMap[tc][5] == "") {
				locked = false;
				break;
			}
		}
				
		if(tilesToCheck.length == 0) { 
			locked = false; 
		}
		
		if(o[3] > -1) {

			//tcn = tileMap.filter(it => it[6] == o[3])[0]
			//if(tcn[5] != "") {
			if(tileMap[o[3]][5] != "") {
				locked = true;
			}
		}
		
		return locked;
	
	}
	
	// for older environments
	if (!Object.entries)
		Object.entries =
			function( obj ){
				var ownProps = Object.keys( obj ),
					i = ownProps.length,
					resArray = new Array(i);
				while (i--)
					resArray[i] = [ownProps[i], obj[ownProps[i]]];
				return resArray;
			};


	function getAvailableMoves() {
		
		let tiles = {};
		let left = 0;

		for(let i = 0; i < tileMap.length; i++) {
						
			// kasuje podświetlenie dostępnych ruchów
			/*
			let img = document.getElementById("div1").querySelector("img[id='" + i + "']");
			img.style.filter = null;
			*/
			
			let tileName = tileMap[i][5];
			
			if (tileName != "") {
				
				left++;
				if (!isLocked(i)) {
					
					if (tileName.substring(1,2) == "_") { 
						tileName = tileName.substring(0, 2); 
					}
					if (tiles[tileName] != null) {
						tiles[tileName].push(i);
					}
					else {
						tiles[tileName] = [i];
					}
					// kolorowanie odblokowanych
					if (0)
					{
						let img = document.getElementById("div1").querySelector("img[id='" + i +"']");
						img.style.filter = "brightness(.7)";
					}
					
				}
			}
		}

		return { tiles: Object.entries(tiles), left };
	}

	
	function checkAvailableMoves() {
	
		avail = getAvailableMoves() 
		
		let count = 0;

		for (const [key, value] of avail.tiles) {
			if(value.length > 1) {

				count += value.length == 4 ? 2 : 1;

				// podświetla dostępne ruchy - tylko dla miękiszonów
				if (showAv > 0)
				{
					value.forEach(i => {
						let img = document.getElementById("div1").querySelector("img[id='" + i +"']");
						img.style.filter = "brightness(.7)";
						img.border ="5px solid color blue"
						img.style.borderColor = "blue";
					})
					showAv = 0;
				}
			}
		}

		let av = document.getElementById("avail")
		av.textContent = "moves: " + count;
		console.log("pozostało ruchów: " + count);
		//console.log("pozostało kloców: " + tilesLeft);

		// TODO temp OFF
		if (false && count == 0)
		{
			var msg = avail.left == 0 ? "BRAWO" : "DUPA"
			//alert(msg);
			var div1 = document.getElementById("div1")
			div1.style.display = "none"
			gameOver = document.getElementById("gameOver");
			gameOver.textContent = msg
			gameOver.style.display = "block"
			gameOver.style.top = (window.innerHeight - gameOver.offsetHeight) *.5  + "px";
			gameOver.style.left = (window.innerWidth - gameOver.offsetWidth) * .5 + "px";
		}
		
	}
	
	
	
	function selectTile(id) {
	
		selectedTile = id;
		var img = document.getElementById("div1").querySelector("img[id='" + id + "']")
		img.style.animation = "blinking 1s infinite";
		img.border ="5px solid color blue"
		img.style.borderColor = "blue";
	}
	
	
	
	function unselectTile() {
	
		if(selectedTile > -1) {
		
			var img = document.getElementById("div1").querySelector("img[id='" + selectedTile + "']")
			img.style.animation = null;
			img.border =""
			img.style.filter = null;
			selectedTile = -1;
		}
		
	}
	

	function showAvail() 
    {
        showAv = 1;
        checkAvailableMoves();
    }	


	function undoLastMove() {
		
		if(undo.length > 0) {
		
			var div1 = document.getElementById("div1")
			div1.style.display = "block"
			gameOver = document.getElementById("gameOver");
			gameOver.style.display = "none"

			const tileName2 = undo.pop();
			const id2 = undo.pop();
			const tileName1 = undo.pop();
			const id1 = undo.pop();
			document.getElementById("div1").querySelector("img[id='" + id1 + "']").style.display = "block";
			tileMap[id1][5] = tileName1;
			document.getElementById("div1").querySelector("img[id='" + id2 + "']").style.display = "block";
			tileMap[id2][5] = tileName2;
			
			unselectTile();
			checkAvailableMoves();
		}
		
	}
	
	
	
	function tileClick(e) {
		
		const id = parseInt(e.currentTarget.id);
				
		let locked = isLocked(id)
		console.log("id " + id + " locked " + locked + " nm " + tileMap[id][5]);

		if (locked) {
			return;
		}
		
		if(selectedTile == -1) {
			selectTile(id);
		}
		else {
			if(selectedTile == id) {
				unselectTile();
			}
			else {
			
				let tileName1 = tileMap[id][5];
				let tileName2 = tileMap[selectedTile][5];
				//if(tileName1 == tileName2 || (tileName1.substring(0,2) == "s_" && tileName2.substring(0,2) == "s_") || (tileName1.substring(0,2) == "f_" && tileName2.substring(0,2) == "f_")) 
                if (tileName1.substring(0,2) == tileName2.substring(0,2))
                {
				
					tileMap[id][5] = "";
					tileMap[selectedTile][5] = "";
					document.getElementById("div1").querySelector("img[id='" + selectedTile + "']").style.display = "none";
					document.getElementById("div1").querySelector("img[id='" + id + "']").style.display = "none";
					
					undo.push(id);
					undo.push(tileName1);
					undo.push(selectedTile);
					undo.push(tileName2);
					
					unselectTile();
					checkAvailableMoves();
				}
			}
		}
	}

    function toggleFullScreen() {
        if(document.fullscreenElement) {

            if (document.exitFullscreen) {
                document.exitFullscreen();
                // safari
            } else if (document.webkitExitFullscreen) {
                document.webkitExitFullscreen();
            } else if (document.msExitFullscreen) {
                // IE11
                document.msExitFullscreen();
            }
        }
        else {
            if (document.documentElement.requestFullscreen) {
                document.documentElement.requestFullscreen();
            } else if (document.documentElement.webkitRequestFullscreen) {
                // safari
                document.documentElement.webkitRequestFullscreen();
            } else if (document.documentElement.msRequestFullscreen) {
                // IE11
                document.documentElement.msRequestFullscreen();
            }
        }
    }

</script>

<button onclick="toggleFullScreen()">full screen</button>
<button onclick="undoLastMove()">undo</button>
<button onclick="showAvail()">show</button>
<div id="avail">***</div>
<div id="div1"></div>
<div id="gameOver"/>
</body>
</html>
